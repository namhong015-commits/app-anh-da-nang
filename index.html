<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI T·∫°o ·∫¢nh ƒê√† N·∫µng ‚Äì Pro UI</title>
  <!-- TailwindCSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { brand: { 500: '#7c3aed', 600: '#6d28d9' } }
        }
      },
      darkMode: 'class'
    };
  </script>
</head>
<body class="bg-zinc-900 text-zinc-100 min-h-screen">
  <header class="border-b border-zinc-800 bg-zinc-950/60 sticky top-0 backdrop-blur">
    <div class="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between">
      <h1 class="text-xl md:text-2xl font-semibold">
        <span class="text-brand-500">üñºÔ∏è AI</span> T·∫°o ·∫£nh t·ª´ m√¥ t·∫£
      </h1>
      <div class="text-sm text-zinc-400 hidden md:block">
        gpt-image-1 ‚Ä¢ Railway
      </div>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 py-6 space-y-6">
    <!-- Alert -->
    <div id="alert" class="hidden rounded-lg border border-rose-500/30 bg-rose-500/10 text-rose-200 px-4 py-3 text-sm"></div>

    <!-- Card: Controls -->
    <section class="rounded-2xl border border-zinc-800 bg-zinc-950/50 p-4 md:p-6 space-y-4">
      <!-- Prompt + chips -->
      <div>
        <label for="prompt" class="block text-sm mb-2 text-zinc-300">M√¥ t·∫£ b·ª©c ·∫£nh</label>
        <textarea id="prompt" rows="3" placeholder="V√≠ d·ª•: M·ªôt con m√®o ƒë·ªôi m≈© phi h√†nh gia ƒëang bay trong kh√¥ng gian..."
          class="w-full rounded-xl bg-zinc-900/80 border border-zinc-800 focus:border-brand-500 focus:ring-2 focus:ring-brand-500/30 outline-none px-4 py-3"></textarea>

        <!-- Quick chips -->
        <div class="flex flex-wrap gap-2 mt-3 text-sm">
          <button class="chip">Phong c√°ch anime, √°nh s√°ng m·ªÅm</button>
          <button class="chip">Phong c√°ch studio, ƒë·ªô chi ti·∫øt cao</button>
          <button class="chip">M√†u n∆∞·ªõc, t√¥ng pastel</button>
          <button class="chip">B·∫ßu tr·ªùi ƒë·∫ßy sao, kh√¥ng gian v≈© tr·ª•</button>
        </div>
      </div>

      <!-- Row: size + count + actions -->
      <div class="grid md:grid-cols-3 gap-3">
        <div>
          <label for="size" class="block text-sm mb-2 text-zinc-300">K√≠ch th∆∞·ªõc</label>
          <select id="size" class="w-full rounded-xl bg-zinc-900/80 border border-zinc-800 focus:border-brand-500 focus:ring-2 focus:ring-brand-500/30 px-4 py-3">
            <option value="1024x1024" selected>1024√ó1024 (vu√¥ng)</option>
            <option value="1024x1536">1024√ó1536 (d·ªçc)</option>
            <option value="1536x1024">1536√ó1024 (ngang)</option>
            <option value="auto">T·ª± ƒë·ªông (auto)</option>
          </select>
        </div>

        <div>
          <label for="count" class="block text-sm mb-2 text-zinc-300">S·ªë l∆∞·ª£ng ·∫£nh</label>
          <select id="count" class="w-full rounded-xl bg-zinc-900/80 border border-zinc-800 focus:border-brand-500 focus:ring-2 focus:ring-brand-500/30 px-4 py-3">
            <option>1</option>
            <option>2</option>
            <option>3</option>
            <option>4</option>
          </select>
        </div>

        <div class="flex items-end gap-3">
          <button id="btn-generate"
            class="flex-1 rounded-xl bg-brand-500 hover:bg-brand-600 transition px-4 py-3 font-medium disabled:opacity-60 disabled:cursor-not-allowed">
            üöÄ T·∫°o ·∫£nh
          </button>
          <button id="btn-clear"
            class="rounded-xl border border-zinc-700 hover:bg-zinc-800 transition px-4 py-3">
            ‚ú® Xo√° k·∫øt qu·∫£
          </button>
        </div>
      </div>
    </section>

    <!-- Gallery + history -->
    <section class="grid lg:grid-cols-4 gap-6">
      <!-- Gallery -->
      <div class="lg:col-span-3 space-y-4">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-medium text-zinc-200">K·∫øt qu·∫£</h2>
          <div id="loading" class="hidden text-sm text-zinc-400">ƒêang t·∫°o ·∫£nh, vui l√≤ng ƒë·ª£i‚Ä¶</div>
        </div>

        <div id="grid" class="grid sm:grid-cols-2 xl:grid-cols-3 gap-4"></div>
      </div>

      <!-- History -->
      <aside class="lg:col-span-1 space-y-3">
        <div class="rounded-2xl border border-zinc-800 bg-zinc-950/50 p-4">
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-medium text-zinc-200">L·ªãch s·ª≠</h3>
            <button id="btn-history-clear" class="text-xs text-zinc-400 hover:text-zinc-200">X√≥a</button>
          </div>
          <div id="history" class="space-y-2 text-sm"></div>
        </div>
      </aside>
    </section>
  </main>

  <footer class="py-10 text-center text-xs text-zinc-500">
    Made with ‚ô• in ƒê√† N·∫µng ‚Äì gpt-image-1 ‚Ä¢ Railway
  </footer>

  <style>
    .chip {
      padding: .4rem .7rem;
      border-radius: .75rem;
      background: rgba(244, 244, 245, .03);
      border: 1px solid rgba(63, 63, 70, .8);
    }
    .chip:hover { border-color: rgba(124, 58, 237, .7); color:#ddd }
    .card {
      background: rgba(24, 24, 27, .6);
      border: 1px solid rgba(39, 39, 42, .8);
      border-radius: .8rem;
      overflow: hidden;
    }
  </style>

  <script>
    // ====== DOM ======
    const elPrompt  = document.getElementById('prompt');
    const elSize    = document.getElementById('size');
    const elCount   = document.getElementById('count');
    const elGrid    = document.getElementById('grid');
    const elAlert   = document.getElementById('alert');
    const elLoading = document.getElementById('loading');
    const btnGen    = document.getElementById('btn-generate');
    const btnClear  = document.getElementById('btn-clear');
    const elHistory = document.getElementById('history');
    const btnHistoryClear = document.getElementById('btn-history-clear');

    // ====== Quick chips ======
    document.querySelectorAll('.chip').forEach(chip => {
      chip.addEventListener('click', () => {
        const s = chip.textContent.trim();
        elPrompt.value = elPrompt.value
          ? (elPrompt.value.trim().replace(/\.*$/, '') + ', ' + s)
          : s;
      });
    });

    // ====== Helpers ======
    function showAlert(msg) {
      elAlert.textContent = msg;
      elAlert.classList.remove('hidden');
      setTimeout(() => elAlert.classList.add('hidden'), 5000);
    }
    function setLoading(v) {
      if (v) {
        elLoading.classList.remove('hidden');
        btnGen.disabled = true;
      } else {
        elLoading.classList.add('hidden');
        btnGen.disabled = false;
      }
    }
    function normalizeImageURL(res) {
      // C·ªë g·∫Øng ‚Äúƒëo√°n‚Äù URL ·∫£nh t·ª´ nhi·ªÅu ki·ªÉu payload
      if (!res) return null;
      if (typeof res === 'string') return res;
      if (res.url) return res.url;
      if (res.image_url) return res.image_url;
      if (res.data && res.data[0]?.url) return res.data[0].url;
      if (res.b64_json) return 'data:image/png;base64,' + res.b64_json;
      return null;
    }
    function addToHistory(item) {
      const key = 'image-history';
      const arr = JSON.parse(localStorage.getItem(key) || '[]');
      arr.unshift({ ...item, ts: Date.now() });
      localStorage.setItem(key, JSON.stringify(arr.slice(0, 20)));
      renderHistory();
    }
    function renderHistory() {
      const key = 'image-history';
      const arr = JSON.parse(localStorage.getItem(key) || '[]');
      elHistory.innerHTML = '';
      if (!arr.length) {
        elHistory.innerHTML = '<div class="text-zinc-500">Ch∆∞a c√≥ l·ªãch s·ª≠.</div>';
        return;
      }
      for (const it of arr) {
        const div = document.createElement('div');
        div.className = 'p-2 rounded-lg bg-zinc-900/70 border border-zinc-800 hover:border-zinc-700 cursor-pointer';
        const time = new Date(it.ts).toLocaleString();
        div.innerHTML = `
          <div class="text-zinc-300 line-clamp-2">${it.prompt}</div>
          <div class="text-xs text-zinc-500 mt-1">${it.size} ‚Ä¢ ${time}</div>`;
        div.onclick = () => { elPrompt.value = it.prompt; elSize.value = it.size; window.scrollTo({top:0,behavior:'smooth'}); };
        elHistory.appendChild(div);
      }
    }
    btnHistoryClear.onclick = () => { localStorage.removeItem('image-history'); renderHistory(); };

    function cardHTML(url) {
      return `
        <div class="card group">
          <div class="aspect-square bg-zinc-900/60 overflow-hidden">
            <img src="${url}" alt="AI image" class="w-full h-full object-cover group-hover:scale-[1.02] transition"/>
          </div>
          <div class="p-3 flex items-center gap-2 border-t border-zinc-800 bg-zinc-950/40">
            <a href="${url}" target="_blank"
               class="text-xs px-3 py-2 rounded-lg border border-zinc-700 hover:bg-zinc-800">M·ªü tab</a>
            <button class="text-xs px-3 py-2 rounded-lg border border-zinc-700 hover:bg-zinc-800"
                    onclick="downloadImage('${url}')">T·∫£i v·ªÅ</button>
            <button class="text-xs px-3 py-2 rounded-lg border border-zinc-700 hover:bg-zinc-800"
                    onclick="navigator.clipboard.writeText('${url}');">Copy link</button>
          </div>
        </div>`;
    }
    window.downloadImage = async function(url) {
      const res = await fetch(url);
      const blob = await res.blob();
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'ai-image.png';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(a.href);
    }

    // ====== Generate flow ======
    btnGen.addEventListener('click', async () => {
      const prompt = elPrompt.value.trim();
      const size   = elSize.value;
      const n      = parseInt(elCount.value, 10) || 1;

      if (!prompt) return showAlert('H√£y nh·∫≠p m√¥ t·∫£ tr∆∞·ªõc nh√©!');

      setLoading(true);
      elAlert.classList.add('hidden');

      // G·ªçi nhi·ªÅu l·∫ßn /generate ƒë·ªÉ t·∫°o nhi·ªÅu ·∫£nh (kh√¥ng c·∫ßn s·ª≠a backend)
      try {
        const tasks = Array.from({ length: n }, () =>
          fetch('/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt, size })
          }).then(r => {
            if (!r.ok) throw new Error('API tr·∫£ l·ªói ' + r.status);
            return r.json();
          })
        );
        const results = await Promise.all(tasks);

        // Hi·ªÉn th·ªã
        const urls = results.map(normalizeImageURL).filter(Boolean);
        if (!urls.length) throw new Error('Kh√¥ng nh·∫≠n ƒë∆∞·ª£c URL ·∫£nh h·ª£p l·ªá.');

        addToHistory({ prompt, size });
        for (const url of urls) elGrid.insertAdjacentHTML('afterbegin', cardHTML(url));
      } catch (err) {
        console.error(err);
        showAlert('T·∫°o ·∫£nh th·∫•t b·∫°i: ' + (err.message || err));
      } finally {
        setLoading(false);
      }
    });

    // Clear gallery
    btnClear.onclick = () => { elGrid.innerHTML = ''; };

    // Render history on load
    renderHistory();
  </script>
</body>
</html>
